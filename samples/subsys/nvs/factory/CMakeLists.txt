# SPDX-License-Identifier: Apache-2.0

cmake_minimum_required(VERSION 3.20.0)

# Check whether the mandatory variables have been defined
if(NOT DEFINED FACTORY_BINARY_DIR)
  message(FATAL_ERROR "You must specify the FACTORY_BINARY_DIR variable, \
  see README for an example.")
endif()
if(NOT DEFINED FACTORY_NVS_CONTENT_FILE)
  message(FATAL_ERROR "You must specify the FACTORY_NVS_CONTENT_FILE variable, \
  see README for an example.")
endif()
if(NOT DEFINED FACTORY_NVS_PARTITION_DT_LABEL)
  message(FATAL_ERROR "You must specify the FACTORY_NVS_PARTITION_DT_LABEL variable, \
  see README for an example.")
endif()
if(NOT DEFINED FACTORY_FLASH_ERASE_VALUE)
  message(FATAL_ERROR "You must specify the FACTORY_FLASH_ERASE_VALUE variable, \
  see README for an example.")
endif()
if(NOT DEFINED FACTORY_FLASH_ERASE_BLOCK_SIZE)
  message(FATAL_ERROR "You must specify the FACTORY_FLASH_ERASE_BLOCK_SIZE variable, \
  see README for an example.")
endif()
if(NOT DEFINED FACTORY_FLASH_WRITE_BLOCK_SIZE)
  message(FATAL_ERROR "You must specify the FACTORY_FLASH_WRITE_BLOCK_SIZE variable, \
  see README for an example.")
endif()
if(NOT DEFINED FACTORY_NVS_PARTITION_SIZE)
  message(FATAL_ERROR "You must specify the FACTORY_NVS_PARTITION_SIZE variable, \
  see README for an example.")
endif()

file(WRITE ${FACTORY_BINARY_DIR}/generated_flash_controller.overlay
"/*
 * This file is automatically generated, do not modify
 */

/ {
        /* Entirely specify the flash controller 0 with the factory target board settings */
        flashcontroller0: flash-controller@0 {
                compatible = \"zephyr,sim-flash\";
                reg = < 0x0 0x200000 >;
                #address-cells = < 0x1 >;
                #size-cells = < 0x1 >;
                erase-value = < ${FACTORY_FLASH_ERASE_VALUE} >;
                flash0: flash@0 {
                        status = \"okay\";
                        compatible = \"soc-nv-flash\";
                        erase-block-size = < ${FACTORY_FLASH_ERASE_BLOCK_SIZE} >;
                        write-block-size = < ${FACTORY_FLASH_WRITE_BLOCK_SIZE} >;
                        reg = < 0x0 ${FACTORY_NVS_PARTITION_SIZE} >;
                        partitions {
                                compatible = \"fixed-partitions\";
                                #address-cells = < 0x1 >;
                                #size-cells = < 0x1 >;
                                ${FACTORY_NVS_PARTITION_DT_LABEL}: partition@0 {
                                        label = \"storage\";
                                        reg = < 0x0 ${FACTORY_NVS_PARTITION_SIZE} >;
                                };
                        };
                };
        };
};
"
)

set(DTC_OVERLAY_FILE
  remove_default_flash_controller.overlay
  ${FACTORY_BINARY_DIR}/generated_flash_controller.overlay
)

find_package(Zephyr REQUIRED HINTS $ENV{ZEPHYR_BASE})
project(nvs)

target_sources(app PRIVATE src/main.c ${FACTORY_NVS_CONTENT_FILE})
target_compile_definitions(app PRIVATE FACTORY_NVS_PARTITION_DT_LABEL=${FACTORY_NVS_PARTITION_DT_LABEL})
target_include_directories(app PRIVATE include)
